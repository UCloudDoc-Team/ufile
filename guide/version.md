# 版本控制

该功能目前内测中，暂未开放。

## 简介

版本控制是US3针对用户存储空间（Bucket）提供的一种容灾保护功能，保护用户不会因为错误的覆盖、删除操作，造成数据丢失。

## 版本控制状态

US3版本控制只有关闭、开启和暂停三种不同的状态。

- 关闭：默认状态，未开启版本控制
- 开启：开启状态下，上传相同Object将不会覆盖前一次的数据，每个新上传的Object将生成唯一的版本ID
- 暂停：暂停状态下，每个新上传的Object将生成字符串为"null"的版本ID，并覆盖原有的（若存在）"null"版本

说明

1. 版本控制开启后不可关闭，仅支持暂停操作
2. 开启版本控制后，Bucket中已存在的Object将自动标记为null版本。每次上传同名Object时，系统将保留所有历史版本，请注意及时清理不必要的版本数据
3. 暂停版本控制后，新上传的Object将覆盖同名文件的null版本。请注意：此操作可能导致数据丢失，请谨慎使用。历史版本数据将保持不变，如需清理请手动删除

## 计费

开启过版本控制的Bucket，将按照Bucket内所有Object及其版本所占据的存储空间收取费用。

## 使用说明

### 开启版本控制

用户可以在存储空间>基础设置>版本控制选项中，开启版本控制。

![](/images/guide/多版本_12.png)

开启版本控制后，用户可以在文件管理界面右上角选择是否展示历史版本。选择后，界面将展示文件的所有版本。

![](/images/guide/多版本_13.png)

可以看到，开启版本控制后重复上传的文件将以历史版本的形式保存下来。

![](/images/guide/多版本_14.png)

### 暂停版本控制

用户可以通过存储空间>基础设置>版本控制>暂停选项，暂停版本控制。

![](/images/guide/多版本_15.png)

暂停版本控制后，新上传版本将会覆盖上为传唯一的null版本。

![](/images/guide/多版本_16.png)

## 功能介绍

### 开启版本控制下的文件操作

#### 上传文件

Bucket开启版本控制后，每次对新上传Object将会生成一个版本ID，这个版本ID在相同Object内唯一。

```
说明：PutFile、PostFile、MultipartUpload、Copy等操作都会对Object生成新的版本。
```

例如，我们对名为demo.txt且在US3上不存在的Object，连续上传三次，US3将会对三次上传的数据都生成一个不重复的版本ID，分别为000001、000002和000003。

![](/images/guide/多版本_1.png)

如果开启版本控制前，原demo1.txt已经存在，那么开启版本控制后此版本将自动变成null版本。此时上传文件，此null版本将变成历史版本。

![](/images/guide/多版本_2.png)

#### 删除文件

开启版本控制后，用户不指定版本ID的删除行为，将不会真实删除文件，而是生成一条删除标记（Delete Marker）。如果用户想要真实删除Object，则可以在删除文件时指定版本ID来永久删除该版本，或者配置生命周期进行删除。

用户可以进行以下两种删除行为：
- 不指定版本ID：不传入版本ID时，此时将会在后端插入一条删除标记，不会对文件进行删除操作

![](/images/guide/多版本_3.png)

- 指定版本ID：将删除指定版本（文件和删除标记），不存在返回404 not found

![](/images/guide/多版本_4.png)

需要注意的是，如果Object的当前版本已经是删除标记，或者该Object不存在，将直接返回404，减少重复无用的删除标记。

![](/images/guide/多版本_5.png)

#### 下载文件

开启Bucket版本控制后，支持下载Object的当前版本或指定版本。

用户可通过以下两种方式获取Object：
- 获取当前版本：不指定版本ID时，系统将返回Object的当前版本。若当前版本为删除标记，则返回404错误

![](/images/guide/多版本_6.png)

- 获取指定版本：指定版本ID时，系统将返回对应版本的文件。若指定版本不存在，则返回404错误

![](/images/guide/多版本_7.png)

#### 列表文件

开启版本控制后，控制台支持两种查看模式：
- 开启历史版本：显示Object的所有版本记录，通过ListObjectVersions接口实现，获取Bucket中所有Object的所有版本，包括删除标记
- 关闭历史版本：仅显示Object的最新版本，通过ListObjects接口实现，获取Bucket中所有Object的最新版本，若最新版本为删除标记则不返回

示例说明：
- 使用ListObjectVersions接口，返回Bucket中所有Object的所有版本记录
- 使用ListObjects接口，由于demo2.txt的当前版本为删除标记，因此仅返回demo1.txt的当前版本

![](/images/guide/多版本_8.png)

### 暂停版本控制下的文件操作

暂停版本控制时，下载文件和列表文件的行为与开启版本控制时没有区别，这里不作重复介绍。

#### 上传文件 

暂停Bucket版本控制后，系统将保留已存在的历史版本，但新上传的Object将覆盖同名文件的null版本，不再生成新的历史版本。每次上传都会生成唯一的null版本ID。

上传规则：
- 当Object不存在null版本时，系统将直接生成null版本
- 当Object已存在null版本时，系统将覆盖该版本并生成新的null版本

如下图所示，当Object不存在null版本时，系统直接生成null版本的当前版本。

![](/images/guide/多版本_9.png)

#### 删除文件

暂停Bucket版本控制后，系统支持两种删除方式：
- 不指定版本ID：将会生成版本ID为null的删除标记。如果此时存在旧的null版本，旧的null版本将会被此null版本的删除标记覆盖
- 指定版本ID：系统将删除指定的版本

![](/images/guide/多版本_11.png)

与版本开启状态下相同，如果Object的当前版本已经是删除标记，或者该Object不存在，将直接返回404。